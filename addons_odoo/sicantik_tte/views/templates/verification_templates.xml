<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template untuk halaman verifikasi dokumen -->
    <template id="verification_page" name="Verification Page">
        <t t-call="web.frontend_layout">
            <div class="container mt-5 mb-5">
                <div class="row justify-content-center">
                    <div class="col-lg-10">
                        <!-- Header dengan Status Keabsahan -->
                        <div class="card shadow-lg mb-4 border-success">
                            <div class="card-header bg-success text-white text-center py-4">
                                <h1 class="mb-2">
                                    <i class="fa fa-check-circle fa-2x"></i>
                                </h1>
                                <h2 class="mb-0">
                                    Dokumen Sah &amp; Tertandatangani Digital
                                </h2>
                                <p class="mb-0 mt-2" style="font-size: 1rem; opacity: 0.9;">
                                    Tanda Tangan Elektronik Terverifikasi
                                </p>
                            </div>
                            
                            <div class="card-body p-4">
                                <!-- Informasi Verifikasi BSRE -->
                                <t t-if="bsre_verification_success and bsre_verification and bsre_verification.get('valid')">
                                    <div class="card border-success mb-4">
                                        <div class="card-header bg-primary text-white">
                                            <h5 class="mb-0">
                                                <i class="fa fa-check-circle"></i> Informasi Verifikasi
                                            </h5>
                                        </div>
                                        <div class="card-body">
                                            <ul class="list-unstyled mb-0">
                                                <li class="mb-2" t-if="bsre_verification.get('document_not_modified')">
                                                    <i class="fa fa-check text-success"></i> 
                                                    Dokumen belum dimodifikasi sejak diberikan tandatangan elektronik
                                                </li>
                                                <li class="mb-2" t-if="bsre_verification.get('timestamp_from_tsa')">
                                                    <i class="fa fa-check text-success"></i> 
                                                    Waktu penandatanganan didapatkan dari Timestamp Authority (TSA)
                                                </li>
                                                <li class="mb-2" t-if="bsre_verification.get('certificate_valid')">
                                                    <i class="fa fa-check text-success"></i> 
                                                    Sertifikat yang digunakan untuk penandatangan dokumen adalah valid
                                                </li>
                                                <li class="mb-0" t-if="bsre_verification.get('long_term_validation')">
                                                    <i class="fa fa-check text-success"></i> 
                                                    Long-Term Validation
                                                </li>
                                                <!-- Fallback: tampilkan semua jika field tidak ada -->
                                                <t t-if="not bsre_verification.get('document_not_modified') and not bsre_verification.get('timestamp_from_tsa')">
                                                    <li class="mb-2">
                                                        <i class="fa fa-check text-success"></i> 
                                                        Dokumen belum dimodifikasi sejak diberikan tandatangan elektronik
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fa fa-check text-success"></i> 
                                                        Waktu penandatanganan didapatkan dari Timestamp Authority (TSA)
                                                    </li>
                                                    <li class="mb-2">
                                                        <i class="fa fa-check text-success"></i> 
                                                        Sertifikat yang digunakan untuk penandatangan dokumen adalah valid
                                                    </li>
                                                    <li class="mb-0">
                                                        <i class="fa fa-check text-success"></i> 
                                                        Long-Term Validation
                                                    </li>
                                                </t>
                                            </ul>
                                        </div>
                                    </div>
                                </t>
                                
                                <!-- Penjelasan Keabsahan Tanda Tangan Elektronik -->
                                <div class="alert alert-success border-left-success border-left-4 mb-4">
                                    <h5 class="alert-heading">
                                        <i class="fa fa-shield-alt"></i> Keabsahan Tanda Tangan Elektronik
                                    </h5>
                                    <p class="mb-2">
                                        Dokumen ini telah ditandatangani secara digital menggunakan <strong>BSRE (Balai Sertifikat Elektronik)</strong> 
                                        yang merupakan lembaga sertifikasi elektronik resmi di Indonesia. Tanda tangan elektronik ini memiliki 
                                        kekuatan hukum yang sama dengan tanda tangan basah sesuai dengan Undang-Undang No. 11 Tahun 2008 
                                        tentang Informasi dan Transaksi Elektronik (UU ITE).
                                    </p>
                                    <hr/>
                                    <p class="mb-0">
                                        <t t-if="bsre_verification_success and bsre_verification">
                                            <strong>Status Verifikasi BSRE:</strong> 
                                            <t t-if="bsre_verification.get('valid')">
                                                <span class="badge badge-success">✅ Tanda Tangan Valid</span>
                                            </t>
                                            <t t-else="">
                                                <span class="badge badge-warning">⚠️ Tanda Tangan Tidak Valid</span>
                                            </t>
                                            <br/>
                                            <small class="text-muted">Diverifikasi langsung ke BSRE API pada <t t-out="document.last_verified_date" t-options="{'widget': 'datetime'}"/></small>
                                        </t>
                                        <t t-else="">
                                            <strong>Status Verifikasi:</strong> Dokumen ini telah terverifikasi keasliannya dan integritasnya. 
                                            Setiap perubahan pada dokumen akan merusak tanda tangan digital dan dapat dideteksi melalui verifikasi.
                                        </t>
                                    </p>
                                </div>
                                
                                <!-- Document Information -->
                                <h4 class="border-bottom pb-2 mb-3">
                                    <i class="fa fa-file-alt"></i> Informasi Dokumen
                                </h4>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Nomor Dokumen:</div>
                                    <div class="col-md-8">
                                        <span class="badge badge-primary badge-lg" style="font-size: 1rem; padding: 0.5rem 1rem;">
                                            <t t-out="document.document_number"/>
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Nama Dokumen:</div>
                                    <div class="col-md-8"><t t-out="document.name"/></div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Nomor Izin:</div>
                                    <div class="col-md-8"><t t-out="document.permit_number"/></div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Jenis Izin:</div>
                                    <div class="col-md-8"><t t-out="document.permit_type_id.name"/></div>
                                </div>
                                
                                <!-- Signature Information -->
                                <h4 class="border-bottom pb-2 mb-3 mt-4">
                                    <i class="fa fa-signature"></i> Informasi Tandatangan
                                </h4>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Waktu Penandatanganan:</div>
                                    <div class="col-md-8">
                                        <strong>
                                            <t t-if="bsre_verification and bsre_verification.get('signature_date')">
                                                <t t-out="bsre_verification['signature_date']"/>
                                            </t>
                                            <t t-else="">
                                                <t t-out="document.signature_date" t-options="{'widget': 'datetime'}"/>
                                            </t>
                                        </strong>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Lokasi:</div>
                                    <div class="col-md-8">
                                        <t t-if="bsre_verification and bsre_verification.get('location')">
                                            <t t-out="bsre_verification['location']"/>
                                        </t>
                                        <t t-else="">
                                            <span class="text-muted">null</span>
                                        </t>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Alasan:</div>
                                    <div class="col-md-8">
                                        <t t-if="bsre_verification and bsre_verification.get('reason')">
                                            <t t-out="bsre_verification['reason']"/>
                                        </t>
                                        <t t-else="">
                                            <span class="text-muted">null</span>
                                        </t>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Penandatangan:</div>
                                    <div class="col-md-8">
                                        <!-- PRIORITAS: Gunakan informasi dari BSRE verify response -->
                                        <t t-if="bsre_verification and bsre_verification.get('signer')">
                                            <strong><t t-out="bsre_verification['signer']"/></strong>
                                            <t t-if="bsre_verification.get('signer_identifier')">
                                                <br/>
                                                <small class="text-muted">
                                                    <t t-set="signer_id" t-value="bsre_verification.get('signer_identifier')"/>
                                                    <t t-if="signer_id and '@' in signer_id">
                                                        Email: <t t-out="signer_id"/>
                                                    </t>
                                                    <t t-else="">
                                                        NIK: <t t-out="signer_id"/>
                                                    </t>
                                                </small>
                                            </t>
                                        </t>
                                        <!-- FALLBACK: Gunakan informasi dari database jika verify response tidak ada -->
                                        <t t-elif="document.bsre_signer_name">
                                            <strong><t t-out="document.bsre_signer_name"/></strong>
                                            <t t-if="document.bsre_signer_identifier">
                                                <br/>
                                                <small class="text-muted">
                                                    <t t-if="document.bsre_signer_identifier and '@' in document.bsre_signer_identifier">
                                                        Email: <t t-out="document.bsre_signer_identifier"/>
                                                    </t>
                                                    <t t-else="">
                                                        NIK: <t t-out="document.bsre_signer_identifier"/>
                                                    </t>
                                                </small>
                                            </t>
                                        </t>
                                        <!-- FALLBACK TERAKHIR: Gunakan user yang melakukan signing (tidak ideal) -->
                                        <t t-else="">
                                            <strong><t t-out="document.signer_id.name"/></strong>
                                            <small class="text-muted d-block">(User yang melakukan tanda tangan - informasi BSRE tidak tersedia)</small>
                                        </t>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Penanda Waktu:</div>
                                    <div class="col-md-8">
                                        <t t-if="bsre_verification and bsre_verification.get('timestamp_authority')">
                                            <t t-out="bsre_verification['timestamp_authority']"/>
                                        </t>
                                        <t t-else="">
                                            Timestamp Authority Badan Siber dan Sandi Negara
                                        </t>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Metode Tanda Tangan:</div>
                                    <div class="col-md-8">
                                        <span class="badge badge-info badge-lg" style="font-size: 0.9rem; padding: 0.4rem 0.8rem;">
                                            <i class="fa fa-certificate"></i> BSRE TTE (Balai Sertifikat Elektronik)
                                        </span>
                                    </div>
                                </div>
                                
                                <t t-if="document.bsre_signature_id">
                                    <div class="row mb-3">
                                        <div class="col-md-4 font-weight-bold">BSRE Signature ID:</div>
                                        <div class="col-md-8">
                                            <code style="font-size: 0.9rem;"><t t-out="document.bsre_signature_id"/></code>
                                        </div>
                                    </div>
                                </t>
                                
                                <t t-if="document.bsre_request_id">
                                    <div class="row mb-3">
                                        <div class="col-md-4 font-weight-bold">BSRE Request ID:</div>
                                        <div class="col-md-8">
                                            <code style="font-size: 0.9rem;"><t t-out="document.bsre_request_id"/></code>
                                        </div>
                                    </div>
                                </t>
                                
                                <!-- Security Information -->
                                <h4 class="border-bottom pb-2 mb-3 mt-4">
                                    <i class="fa fa-lock"></i> Informasi Keamanan &amp; Integritas
                                </h4>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Hash Dokumen (SHA256):</div>
                                    <div class="col-md-8">
                                        <code style="font-size: 0.85rem; word-break: break-all; background-color: #f8f9fa; padding: 0.5rem; border-radius: 0.25rem; display: block;">
                                            <t t-out="document.file_hash"/>
                                        </code>
                                        <small class="text-muted">Hash ini dapat digunakan untuk memverifikasi integritas dokumen</small>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Ukuran File:</div>
                                    <div class="col-md-8">
                                        <t t-out="'%.2f' % (document.file_size / 1024)"/> KB
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-md-4 font-weight-bold">Jumlah Verifikasi:</div>
                                    <div class="col-md-8">
                                        <span class="badge badge-secondary"><t t-out="document.verification_count"/> kali</span>
                                    </div>
                                </div>
                                
                                <t t-if="document.last_verified_date">
                                    <div class="row mb-3">
                                        <div class="col-md-4 font-weight-bold">Terakhir Diverifikasi:</div>
                                        <div class="col-md-8">
                                            <t t-out="document.last_verified_date" t-options="{'widget': 'datetime'}"/>
                                        </div>
                                    </div>
                                </t>
                                
                                <!-- Download Section -->
                                <div class="card bg-light mt-4 mb-4">
                                    <div class="card-body text-center">
                                        <h5 class="mb-3">
                                            <i class="fa fa-download"></i> Download Dokumen Tertandatangani
                                        </h5>
                                        <p class="text-muted mb-3">
                                            Unduh dokumen PDF yang telah ditandatangani secara digital untuk keperluan arsip atau verifikasi lebih lanjut.
                                        </p>
                                        <t t-if="document.download_token">
                                            <a t-attf-href="/sicantik/tte/download/#{document.document_number}/#{document.download_token}?filename=#{document.original_filename}" 
                                               class="btn btn-lg btn-primary btn-block" 
                                               style="max-width: 400px; margin: 0 auto;">
                                                <i class="fa fa-download"></i> Download Dokumen PDF
                                            </a>
                                        </t>
                                        <t t-else="">
                                            <p class="text-muted">Token download sedang di-generate, silakan refresh halaman.</p>
                                        </t>
                                    </div>
                                </div>
                                
                                <!-- Info Footer -->
                                <div class="alert alert-info mt-4 mb-0">
                                    <h6 class="alert-heading">
                                        <i class="fa fa-info-circle"></i> Informasi Penting
                                    </h6>
                                    <ul class="mb-0 pl-3">
                                        <li>
                                            Dokumen ini telah ditandatangani secara digital menggunakan <strong>BSRE (Balai Sertifikat Elektronik)</strong> 
                                            yang merupakan lembaga sertifikasi elektronik resmi di Indonesia.
                                        </li>
                                        <li>
                                            Tanda tangan elektronik ini memiliki <strong>kekuatan hukum yang sama dengan tanda tangan basah</strong> 
                                            sesuai dengan Undang-Undang No. 11 Tahun 2008 tentang Informasi dan Transaksi Elektronik (UU ITE).
                                        </li>
                                        <li>
                                            Hash SHA256 dapat digunakan untuk memverifikasi integritas dokumen. 
                                            Setiap perubahan pada dokumen akan menghasilkan hash yang berbeda.
                                        </li>
                                        <li>
                                            Dokumen ini dapat diverifikasi kapan saja dengan mengakses URL verifikasi atau memindai QR code yang terdapat pada dokumen.
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template untuk dokumen tidak ditemukan -->
    <template id="verification_not_found" name="Verification Not Found">
        <t t-call="web.frontend_layout">
            <div class="container mt-5 mb-5">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow-lg">
                            <div class="card-header bg-danger text-white text-center py-4">
                                <h2 class="mb-0">
                                    <i class="fa fa-exclamation-triangle"></i> Dokumen Tidak Ditemukan
                                </h2>
                            </div>
                            <div class="card-body p-4 text-center">
                                <p class="lead">Nomor Dokumen: <strong><t t-out="document_number"/></strong></p>
                                <p class="text-muted">
                                    Dokumen dengan nomor tersebut tidak ditemukan atau belum ditandatangani.
                                </p>
                                <p class="text-muted" t-if="message">
                                    <t t-out="message"/>
                                </p>
                                <div class="mt-4">
                                    <a href="/" class="btn btn-primary">Kembali ke Beranda</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
    
    <!-- Template untuk error -->
    <template id="verification_error" name="Verification Error">
        <t t-call="web.frontend_layout">
            <div class="container mt-5 mb-5">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow-lg">
                            <div class="card-header bg-danger text-white text-center py-4">
                                <h2 class="mb-0">
                                    <i class="fa fa-exclamation-circle"></i> Error Verifikasi
                                </h2>
                            </div>
                            <div class="card-body p-4 text-center">
                                <p class="lead" t-if="document_number">
                                    Nomor Dokumen: <strong><t t-out="document_number"/></strong>
                                </p>
                                <p class="text-danger">
                                    <t t-out="error"/>
                                </p>
                                <div class="mt-4">
                                    <a href="/" class="btn btn-primary">Kembali ke Beranda</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </t>
    </template>
</odoo>

