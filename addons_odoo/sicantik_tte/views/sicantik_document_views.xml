<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Document Form View -->
    <record id="view_sicantik_document_form" model="ir.ui.view">
        <field name="name">sicantik.document.form</field>
        <field name="model">sicantik.document</field>
        <field name="arch" type="xml">
            <form string="Dokumen Perizinan">
                <header>
                    <button name="action_open_upload_wizard" type="object" 
                            string="ðŸ“¤ Upload Dokumen Baru"
                            class="btn-primary"/>
                    <button name="action_request_signature" type="object" string="Minta Tanda Tangan"
                            class="btn-primary" invisible="state != 'uploaded'"/>
                    <button name="action_sign_with_bsre" type="object" string="Tandatangani dengan BSRE"
                            class="btn-primary" invisible="state != 'pending_signature'"
                            groups="base.group_system"/>
                    <button name="action_download_from_minio" type="object" string="Unduh Dokumen"
                            class="btn-secondary" invisible="can_download == False"/>
                    <button name="action_embed_qr_code" type="object" string="Embed QR Code"
                            class="btn-info" invisible="qr_code_embedded == True or state != 'signed'"
                            groups="base.group_system"/>
                    <button name="action_cancel" type="object" string="Batalkan"
                            class="btn-warning" invisible="state in ['signed', 'verified', 'cancelled']"
                            confirm="Apakah Anda yakin ingin membatalkan dokumen ini?"/>
                    <field name="state" widget="statusbar" 
                           statusbar_visible="draft,uploaded,pending_signature,signed,verified"/>
                </header>
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <!-- Stat button tanpa action untuk menampilkan ukuran file -->
                        <button class="oe_stat_button" icon="fa-file-pdf-o" disabled="1">
                            <field name="file_size" widget="statinfo" string="Ukuran File"/>
                        </button>
                        <!-- Stat button untuk workflow -->
                        <button name="%(action_signature_workflow)d" type="action" 
                                class="oe_stat_button" icon="fa-pencil-square-o"
                                context="{'search_default_document_id': id}">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Workflow</span>
                            </div>
                        </button>
                        <!-- Stat button tanpa action untuk menampilkan jumlah verifikasi -->
                        <button class="oe_stat_button" icon="fa-check-circle" 
                                disabled="1" invisible="verification_count == 0">
                            <field name="verification_count" widget="statinfo" string="Verifikasi"/>
                        </button>
                    </div>
                    
                    <widget name="web_ribbon" title="Tertandatangani" bg_color="bg-success"
                            invisible="state != 'signed'"/>
                    <widget name="web_ribbon" title="Terverifikasi" bg_color="bg-info"
                            invisible="state != 'verified'"/>
                    <widget name="web_ribbon" title="Ditolak" bg_color="bg-danger"
                            invisible="state != 'rejected'"/>
                    
                    <div class="oe_title">
                        <label for="name" class="oe_edit_only"/>
                        <h1>
                            <field name="name" placeholder="Nama Dokumen"/>
                        </h1>
                        <h3>
                            <field name="document_number" readonly="1"/>
                        </h3>
                    </div>
                    
                    <group>
                        <group string="Informasi Izin">
                            <field name="permit_id" options="{'no_create': True}"/>
                            <field name="permit_number" readonly="1"/>
                            <field name="permit_type_id" readonly="1"/>
                        </group>
                        <group string="Informasi File">
                            <field name="original_filename" readonly="1"/>
                            <field name="file_size" widget="integer" readonly="1"/>
                            <field name="file_hash" readonly="1"/>
                            <field name="upload_date" readonly="1"/>
                            <field name="uploaded_by" readonly="1"/>
                        </group>
                    </group>
                    
                    <notebook>
                        <page string="Storage" name="storage">
                            <group>
                                <group string="MinIO Storage">
                                    <field name="minio_bucket" readonly="1"/>
                                    <field name="minio_object_name" readonly="1"/>
                                    <field name="minio_url" widget="url" readonly="1"/>
                                </group>
                            </group>
                        </page>
                        
                        <page string="Tanda Tangan" name="signature" invisible="state in ['draft', 'uploaded']">
                            <group>
                                <group string="Informasi Tanda Tangan">
                                    <field name="signature_date" readonly="1"/>
                                    <field name="signer_id" readonly="1"/>
                                    <field name="signature_method" readonly="1"/>
                                </group>
                                <group string="BSRE Information" invisible="signature_method != 'bsre'">
                                    <field name="bsre_request_id" readonly="1"/>
                                    <field name="bsre_signature_id" readonly="1"/>
                                </group>
                            </group>
                            <group string="Sertifikat BSRE" invisible="signature_method != 'bsre'">
                                <field name="bsre_certificate" widget="text" readonly="1"/>
                            </group>
                        </page>
                        
                        <page string="QR Code" name="qr_code" invisible="state not in ['signed', 'verified']">
                            <group>
                                <group string="QR Code Information">
                                    <field name="qr_code_embedded" readonly="1"/>
                                    <field name="download_url" widget="url" readonly="1" string="QR Code URL (Download)"/>
                                    <field name="verification_url" widget="url" readonly="1"/>
                                </group>
                                <group string="QR Code Image">
                                    <field name="qr_code_image" widget="image" readonly="1"/>
                                </group>
                            </group>
                            <group string="QR Code Data">
                                <field name="qr_code_data" widget="text" readonly="1"/>
                            </group>
                        </page>
                        
                        <page string="Verifikasi" name="verification" invisible="state not in ['signed', 'verified']">
                            <group>
                                <field name="verification_count" readonly="1"/>
                                <field name="last_verified_date" readonly="1"/>
                            </group>
                        </page>
                        
                        <page string="Catatan" name="notes">
                            <field name="notes" placeholder="Tambahkan catatan..."/>
                        </page>
                    </notebook>
                    
                    <!-- Hidden fields for computed -->
                    <field name="can_sign" invisible="1"/>
                    <field name="can_download" invisible="1"/>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- Document List View -->
    <record id="view_sicantik_document_tree" model="ir.ui.view">
        <field name="name">sicantik.document.tree</field>
        <field name="model">sicantik.document</field>
        <field name="arch" type="xml">
            <list string="Dokumen Perizinan" 
                  decoration-success="state == 'signed'"
                  decoration-info="state == 'verified'"
                  decoration-warning="state == 'pending_signature'"
                  decoration-danger="state == 'rejected'"
                  decoration-muted="state == 'cancelled'">
                <field name="document_number"/>
                <field name="name"/>
                <field name="permit_number"/>
                <field name="permit_type_id"/>
                <field name="original_filename"/>
                <field name="file_size" widget="integer"/>
                <field name="upload_date"/>
                <field name="signature_date"/>
                <field name="state" widget="badge"
                       decoration-success="state == 'signed'"
                       decoration-info="state == 'verified'"
                       decoration-warning="state == 'pending_signature'"
                       decoration-danger="state == 'rejected'"/>
            </list>
        </field>
    </record>

    <!-- Document Kanban View -->
    <record id="view_sicantik_document_kanban" model="ir.ui.view">
        <field name="name">sicantik.document.kanban</field>
        <field name="model">sicantik.document</field>
        <field name="arch" type="xml">
            <kanban string="Dokumen" default_group_by="state" class="o_kanban_small_column">
                <field name="document_number"/>
                <field name="name"/>
                <field name="permit_number"/>
                <field name="state"/>
                <field name="qr_code_image"/>
                <field name="create_date"/>
                <templates>
                    <!-- Odoo 18: Use 'card' instead of deprecated 'kanban-box' -->
                    <t t-name="card">
                        <div class="oe_kanban_card oe_kanban_global_click">
                            <!-- QR Code Image Section -->
                            <div class="o_kanban_image_wrapper">
                                <div class="o_kanban_image" style="text-align: center; padding: 10px;">
                                    <!-- FIX: Proper image rendering with widget -->
                                    <t t-if="record.qr_code_image.raw_value">
                                        <field name="qr_code_image" widget="image" 
                                               options="{'size': [120, 120]}"
                                               style="max-width: 120px; max-height: 120px;"/>
                                    </t>
                                    <t t-else="">
                                        <div style="width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; background-color: #f0f0f0; border-radius: 4px;">
                                            <i class="fa fa-file-pdf-o fa-4x text-muted"/>
                                        </div>
                                    </t>
                                </div>
                            </div>
                            
                            <!-- Document Details Section -->
                            <div class="oe_kanban_details">
                                <div class="o_kanban_record_top mb-2">
                                <strong class="o_kanban_record_title">
                                    <field name="name"/>
                                </strong>
                                    <div class="o_dropdown_kanban dropdown">
                                        <a class="dropdown-toggle o-no-caret btn" role="button" data-bs-toggle="dropdown" href="#" aria-label="Dropdown menu">
                                            <span class="fa fa-ellipsis-v"/>
                                        </a>
                                        <div class="dropdown-menu" role="menu">
                                            <a role="menuitem" type="edit" class="dropdown-item">Edit</a>
                                            <a role="menuitem" type="delete" class="dropdown-item">Delete</a>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_record_body">
                                    <div class="row g-0 mb-1">
                                        <div class="col-3 text-muted">No:</div>
                                        <div class="col-9"><field name="document_number"/></div>
                                    </div>
                                    <div class="row g-0 mb-1">
                                        <div class="col-3 text-muted">Izin:</div>
                                        <div class="col-9"><field name="permit_number"/></div>
                                    </div>
                                </div>
                                
                                <div class="o_kanban_record_bottom mt-2">
                                    <div class="oe_kanban_bottom_left">
                                        <field name="state" widget="badge" 
                                               decoration-success="state == 'signed' or state == 'verified'"
                                               decoration-warning="state == 'pending_signature'"
                                               decoration-info="state == 'uploaded'"
                                               decoration-muted="state == 'draft'"/>
                                    </div>
                                    <div class="oe_kanban_bottom_right">
                                        <field name="create_date" widget="date"/>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- Document Search View -->
    <record id="view_sicantik_document_search" model="ir.ui.view">
        <field name="name">sicantik.document.search</field>
        <field name="model">sicantik.document</field>
        <field name="arch" type="xml">
            <search string="Cari Dokumen">
                <field name="document_number"/>
                <field name="name"/>
                <field name="permit_number"/>
                <field name="permit_type_id"/>
                <field name="original_filename"/>
                
                <filter string="Draft" name="draft" domain="[('state', '=', 'draft')]"/>
                <filter string="Terupload" name="uploaded" domain="[('state', '=', 'uploaded')]"/>
                <filter string="Menunggu Tanda Tangan" name="pending_signature" 
                        domain="[('state', '=', 'pending_signature')]"/>
                <filter string="Tertandatangani" name="signed" domain="[('state', '=', 'signed')]"/>
                <filter string="Terverifikasi" name="verified" domain="[('state', '=', 'verified')]"/>
                
                <separator/>
                <filter string="Dokumen Saya" name="my_documents" 
                        domain="[('uploaded_by', '=', uid)]"/>
                <filter string="Dapat Ditandatangani" name="can_sign" 
                        domain="[('state', '=', 'pending_signature')]"
                        groups="base.group_system"/>
                
                <separator/>
                <filter string="Bulan Ini" name="this_month" 
                        domain="[('upload_date', '&gt;=', (context_today() - relativedelta(months=1)).strftime('%Y-%m-%d'))]"/>
                <filter string="Tahun Ini" name="this_year" 
                        domain="[('upload_date', '&gt;=', (context_today() - relativedelta(years=1)).strftime('%Y-%m-%d'))]"/>
                
                <group expand="0" string="Group By">
                    <filter string="Status" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Jenis Izin" name="group_permit_type" context="{'group_by': 'permit_type_id'}"/>
                    <filter string="Tanggal Upload" name="group_upload_date" context="{'group_by': 'upload_date'}"/>
                    <filter string="Penandatangan" name="group_signer" context="{'group_by': 'signer_id'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- Document Action -->
    <record id="action_sicantik_document" model="ir.actions.act_window">
        <field name="name">Dokumen Perizinan</field>
        <field name="res_model">sicantik.document</field>
        <field name="view_mode">kanban,list,form</field>
        <field name="context">{'search_default_uploaded': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Belum ada dokumen
            </p>
            <p>
                Upload dokumen perizinan untuk ditandatangani secara digital.
            </p>
        </field>
    </record>
</odoo>

