services:
  # SICANTIK Existing Application (PHP/CodeIgniter)
  sicantik_web:
    build:
      context: .
      dockerfile: Dockerfile.sicantik
    container_name: sicantik_web
    ports:
      - "8070:80" # SICANTIK web interface
    volumes:
      - .:/var/www/html
      - ./uploads:/var/www/html/uploads
      - ./temp:/var/www/html/temp
    environment:
      - MYSQL_HOST=sicantik_mysql
      - MYSQL_DATABASE=db_office
      - MYSQL_USER=sicantik_user
      - MYSQL_PASSWORD=sicantik_password
    depends_on:
      - sicantik_mysql
    networks:
      - sicantik_network
    restart: unless-stopped

  # MySQL for SICANTIK
  sicantik_mysql:
    image: mysql:8.0
    container_name: sicantik_mysql
    ports:
      - "3307:3306" # Avoid conflict with default MySQL
    environment:
      - MYSQL_ROOT_PASSWORD=root_password_123
      - MYSQL_DATABASE=db_office
      - MYSQL_USER=sicantik_user
      - MYSQL_PASSWORD=sicantik_password
    volumes:
      - sicantik_mysql_data:/var/lib/mysql
      - ./db_office_last-20250711.tar.gz:/docker-entrypoint-initdb.d/db_office.tar.gz
    networks:
      - sicantik_network
    restart: unless-stopped

  # MinIO for Document Storage
  minio_storage:
    image: minio/minio:latest
    container_name: minio_storage
    ports:
      - "9000:9000" # MinIO API (S3 Compatible)
      - "9001:9001" # MinIO Console (Web UI)
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=minioadmin123
      - MINIO_DOMAIN="" # Disable virtual-host style, use path-style only
    volumes:
      - minio_data:/data
    networks:
      - sicantik_network
    command: server /data --console-address ":9001"
    restart: unless-stopped

  # Redis for Caching
  redis_cache:
    image: redis:7-alpine
    container_name: redis_cache
    ports:
      - "6380:6379"
    volumes:
      - redis_data:/data
    networks:
      - sicantik_network
    restart: unless-stopped

  # BSRE Connector Service
  bsre_connector:
    build:
      context: ./services/bsre-connector
      dockerfile: Dockerfile
    container_name: bsre_connector
    ports:
      - "8020:8000"
    env_file:
      - env.development
    environment:
      - BSRE_API_URL=${BSRE_API_URL:-https://api-sandbox.bsre.id/v1}
      - BSRE_CLIENT_ID=${BSRE_CLIENT_ID:-demo_client_id}
      - BSRE_CLIENT_SECRET=${BSRE_CLIENT_SECRET:-demo_client_secret}
      - BSRE_ENVIRONMENT=${BSRE_ENVIRONMENT:-sandbox}
    volumes:
      - ./certs:/app/certs:ro
      - bsre_logs:/app/logs
    networks:
      - sicantik_network
    restart: unless-stopped
  # Odoo 18.4 Enterprise - Standalone Companion App
  odoo_sicantik:
    build:
      context: .
      dockerfile: Dockerfile.odoo
    image: sicantik-odoo:18.4
    container_name: odoo_sicantik
    ports:
      - "8065:8069" # Different port to avoid conflicts
    environment:
      - PGHOST=postgres
      - PGPORT=5432
      - PGUSER=odoo
      - PGPASSWORD=odoo_password_secure
      #- PGDATABASE=sicantik_companion_standalone
    volumes:
      - odoo_data:/var/lib/odoo
      - ./addons_odoo:/mnt/extra-addons
      - ./enterprise:/mnt/enterprise-addons
      - ./config_odoo/odoo.conf:/etc/odoo/odoo.conf:ro
      - ./uploads:/mnt/sicantik_uploads:ro
    # Note: odoo.conf di server produksi tidak akan di-overwrite oleh Git
    # Gunakan odoo.conf.example sebagai template jika perlu membuat baru
      #- ./enterprise-lic.tar.gz:/tmp/enterprise-lic.tar.gz:ro
    depends_on:
      - postgres
      - redis_cache
    networks:
      - sicantik_network
    restart: unless-stopped
    command: ["python3", "odoo-bin", "--config=/etc/odoo/odoo.conf"]
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 1G

  # PostgreSQL for Odoo Companion (Standalone)
  postgres:
    image: postgres:15
    container_name: postgres
    # Port tidak di-expose untuk menghindari konflik dengan container lain
    # Akses via network: postgres_companion_standalone:5432
    environment:
      - POSTGRES_DB=postgres
      - POSTGRES_USER=odoo
      - POSTGRES_PASSWORD=odoo_password_secure
      - PGDATA=/var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data/pgdata
    networks:
      - sicantik_network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M

  # Adminer for Database Management
  adminer:
    image: adminer:latest
    container_name: adminer
    ports:
      - "8090:8080"
    environment:
      - ADMINER_DEFAULT_SERVER=sicantik_mysql
    networks:
      - sicantik_network
    restart: unless-stopped

  # MailHog for Email Testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: mailhog
    ports:
      - "8025:8025" # Web UI
      - "1025:1025" # SMTP
    networks:
      - sicantik_network
    restart: unless-stopped

volumes:
  sicantik_mysql_data:
    driver: local
  postgres_data:
    driver: local
  odoo_data:
    driver: local
  minio_data:
    driver: local
  redis_data:
    driver: local
  bsre_logs:
    driver: local

networks:
  sicantik_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16
