<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

/**
 * Description of perizinan class
 *
 * @author  Yana Supriatna
 * @since   1.0
 *
 */

class Perizinan extends WRC_AdminCont {

    public function __construct() {
        parent::__construct();
        $this->perizinan = new trperizinan();
    }

    public function index() {

        $data['list'] = $this->perizinan->get();
        $this->load->vars($data);

        $js =  "function confirm_link(text){
                    if(confirm(text)){ return true;
                    }else{ return false; }
                }
                $(document).ready(function() {
                        oTable = $('#perizinan').dataTable({
                                \"bJQueryUI\": true,
                                \"sPaginationType\": \"full_numbers\"
                        });
                } );
                ";

        $this->template->set_metadata_javascript($js);
        $this->session_info['page_name'] = "Data Jenis Perizinan";
        $this->template->build('list', $this->session_info);
    }

    public function create() {
        $kabupaten = new trkabupaten();
        $unitkerja = new trunitkerja();
        $kelompok = new trkelompok_perizinan();

        $data['list_kab'] = $kabupaten->order_by('n_kabupaten','ASC')->get()->all;
        $data['list_uk'] = $unitkerja->order_by('n_unitkerja','ASC')->get()->all;
        $data['list_klp'] = $kelompok->order_by('n_kelompok','ASC')->get()->all;

        $data['n_perizinan']  = "";
        $data['v_berlaku_tahun'] = "";
        $data['v_hari'] = "";
        $data['kelompok_id']  = "";
        $data['unitkerja_id']  = "";
        $data['save_method'] = "save";
        $data['id'] = "";

        $js =  "
                $(document).ready(function() {
                    $('#form').validate();
                    $(\"#tabs\").tabs();
                } );
            ";
        $this->template->set_metadata_javascript($js);

        $this->load->vars($data);
        $this->session_info['page_name'] = "Tambah Jenis Perizinan";
        $this->template->build('edit', $this->session_info);
    }

    /*
     * edit is a method to show page for updating data
     */
    public function edit($id_jnsizin = NULL) {

        $this->perizinan->where('id', $id_jnsizin);
        $this->perizinan->get();

        $kelompok = new trkelompok_perizinan();
        $unit = new trunitkerja();
        $this->perizinan->trkelompok_perizinan->get();
        $this->perizinan->trunitkerja->get();

        $data['list_uk'] = $unit->get();
        $data['list_klp'] = $kelompok->get();
        $data['id'] = $this->perizinan->id;
        $data['n_perizinan'] = $this->perizinan->n_perizinan;
        $data['kelompok_id'] = $this->perizinan->trkelompok_perizinan->id;
        $data['unitkerja_id'] = $this->perizinan->trunitkerja->id;
        $data['save_method'] = "update";
        $data['v_berlaku_tahun'] = $this->perizinan->v_berlaku_tahun;
        $data['v_hari'] = $this->perizinan->v_hari;

        $js = "$(document).ready(function(){
                $(\"#tabs\").tabs();
              })";
        $this->template->set_metadata_javascript($js);

        $this->load->vars($data);
        $this->session_info['page_name'] = "Edit Jenis perizinan";
        $this->template->build('edit', $this->session_info);

    }


    /**
     * Not yet in use, because of some limit of dataTables
     */
    public function datalist() {

        $this->perizinan->get();
        $this->perizinan->set_json_content_type();
        echo $this->perizinan->json_for_data_table();

    }

    /*
     * Save and update for manipulating data.
     */
    public function save() {
        $perizinan = new trperizinan();

        $perizinan->n_perizinan = $this->input->post('n_perizinan');
        $perizinan->unitkerja_id = $this->input->post('opsi_uk');
        $perizinan->is_open = $this->input->post('is_open');
        $perizinan->v_berlaku_tahun = $this->input->post('v_berlaku_tahun');
        $perizinan->v_hari = $this->input->post('v_hari');
        $perizinan->c_tarif = 0;

        $unitkerja = new trunitkerja();
        $unitkerja->where('id', $this->input->post('opsi_uk'))->get();

        $kelompok = new trkelompok_perizinan();
        $kelompok->where('id', $this->input->post('opsi_klp'))->get();
        $opsi_klp = $this->input->post('opsi_klp');
        if($opsi_klp === 3 || $opsi_klp === 4 || $opsi_klp === 5) {
            $perizinan->c_tarif = 1;
        } else {
            $perizinan->c_tarif = 0;
        }

        if ($perizinan->save(array($unitkerja,$kelompok))) {
            redirect('perizinan');
        } else {
            echo '<p>' . $this->perizinan->error->string . '</p>';
        }
    }

    public function update() {
        $c_tarif = 0;
        
        $opsi_klp = $this->input->post('opsi_klp');
        if($opsi_klp === '3' || $opsi_klp === '4' || $opsi_klp === '5') {
            $c_tarif = 1;
        } else {
            $c_tarif = 0;
        }

        $update = $this->perizinan
                ->where('id', $this->input->post('id'))
                ->update(array(
                            'is_open' => $this->input->post('is_open'),
                            'c_tarif' => $c_tarif,
                            'v_hari' => $this->input->post('v_hari'),
                            'v_berlaku_tahun' => $this->input->post('v_berlaku_tahun')
                        ));

        $kel = new trperizinan();
        $kel->where('id', $this->input->post('id'))->get();

        $kel2 = new trkelompok_perizinan();
        $kel2->where('id', $this->input->post('opsi_klp'))->get();

        $kel->save($kel2);

        $table_gen_2 = new trperizinan_trunitkerja();

        if($table_gen_2->where('trunitkerja_id',$this->input->post('id'))->count() < 1) {
            $table_gen_2->trunitkerja_id = $this->input->post('opsi_uk');
            $table_gen_2->trperizinan_id = $this->input->post('id');
            $table_gen_2->save();
        } else {
            $table_gen_2->where('trperizinan_id', $this->input->post('id'))
                    ->update(array(
                        'trunitkerja_id' => $this->input->post('opsi_uk')
                    ));
        }

        if($update) {
            redirect('perizinan');
        }
    }

    public function delete($id = NULL) {
        $izin = new trperizinan();
        $izin->where('id',$id)->get();
        if($izin->delete($id))
            redirect('perizinan');
    }

    /*
     * Method for validating
     */

}

// This is the end of perizinan class