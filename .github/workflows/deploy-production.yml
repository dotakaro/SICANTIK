name: Deploy to Production

on:
  push:
    branches:
      - master
  workflow_dispatch: # Allow manual trigger

env:
  DOCKER_COMPOSE_VERSION: '2.24.0'

jobs:
  deploy:
    name: Deploy to Production Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts
      
      - name: Test SSH connection
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "echo 'SSH connection successful'"
      
      - name: Deploy to production server
        run: |
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} bash -s << 'DEPLOY_SCRIPT'
            set -e
            
            # Colors for output
            GREEN='\033[0;32m'
            YELLOW='\033[1;33m'
            RED='\033[0;31m'
            NC='\033[0m'
            
            PROJECT_PATH="${{ secrets.PROJECT_PATH }}"
            
            echo -e "${GREEN}[DEPLOY]${NC} Starting deployment..."
            
            # Navigate to project directory
            if [ ! -d "$PROJECT_PATH" ]; then
              echo -e "${RED}[ERROR]${NC} Project path not found: $PROJECT_PATH"
              exit 1
            fi
            
            cd "$PROJECT_PATH" || {
              echo -e "${RED}[ERROR]${NC} Failed to navigate to project directory"
              exit 1
            }
            
            # Backup database before deployment (optional)
            if [ -f "scripts/backup.sh" ]; then
              echo -e "${YELLOW}[BACKUP]${NC} Creating database backup..."
              bash scripts/backup.sh || echo -e "${YELLOW}[WARN]${NC} Backup failed, continuing..."
            fi
            
            # Pull latest code from GitHub
            echo -e "${GREEN}[GIT]${NC} Pulling latest code..."
            git fetch origin master || {
              echo -e "${RED}[ERROR]${NC} Failed to fetch from origin"
              exit 1
            }
            
            # Handle divergent branches
            LOCAL_COMMITS=$(git rev-list --count HEAD..origin/master 2>/dev/null || echo "0")
            REMOTE_COMMITS=$(git rev-list --count origin/master..HEAD 2>/dev/null || echo "0")
            
            if [ "$REMOTE_COMMITS" -gt 0 ]; then
              echo -e "${YELLOW}[WARN]${NC} Found $REMOTE_COMMITS local commit(s), will reset to origin/master"
            fi
            
            git reset --hard origin/master || {
              echo -e "${RED}[ERROR]${NC} Failed to reset to origin/master"
              exit 1
            }
            
            # Note: odoo.conf sekarang di-track Git, jadi akan ter-update otomatis dari GitHub
            
            # Show current commit
            COMMIT_HASH=$(git rev-parse --short HEAD)
            COMMIT_MSG=$(git log -1 --pretty=%B)
            echo -e "${GREEN}[GIT]${NC} Deploying commit: ${COMMIT_HASH}"
            echo -e "${GREEN}[GIT]${NC} Message: ${COMMIT_MSG}"
            
            # Restart Docker Compose services
            echo -e "${GREEN}[DOCKER]${NC} Restarting Docker Compose services..."
            
            # Check if docker-compose.yml exists
            if [ ! -f "docker-compose.yml" ]; then
              echo -e "${RED}[ERROR]${NC} docker-compose.yml not found"
              exit 1
            fi
            
            # Stop services gracefully
            docker-compose down || echo -e "${YELLOW}[WARN]${NC} Some services may not have stopped cleanly"
            
            # Start services
            docker-compose up -d || {
              echo -e "${RED}[ERROR]${NC} Failed to start Docker Compose services"
              exit 1
            }
            
            # Wait for services to be healthy
            echo -e "${GREEN}[HEALTH]${NC} Waiting for services to be healthy..."
            sleep 10
            
            # Check service status
            docker-compose ps
            
            # Health check for Odoo service
            if docker-compose ps | grep -q "odoo_sicantik.*Up"; then
              echo -e "${GREEN}[HEALTH]${NC} Odoo service is running"
            else
              echo -e "${RED}[ERROR]${NC} Odoo service is not running"
              exit 1
            fi
            
            # Health check for other critical services
            if docker-compose ps | grep -q "sicantik_web.*Up"; then
              echo -e "${GREEN}[HEALTH]${NC} SICANTIK web service is running"
            else
              echo -e "${YELLOW}[WARN]${NC} SICANTIK web service may not be running"
            fi
            
            echo -e "${GREEN}[DEPLOY]${NC} Deployment completed successfully!"
            echo -e "${GREEN}[DEPLOY]${NC} Commit: ${COMMIT_HASH}"
            echo -e "${GREEN}[DEPLOY]${NC} Time: $(date)"
          DEPLOY_SCRIPT
      
      - name: Deployment Summary
        if: success()
        run: |
          echo "## ✅ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Author:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time:** $(date)" >> $GITHUB_STEP_SUMMARY
      
      - name: Deployment Failed
        if: failure()
        run: |
          echo "## ❌ Deployment Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Check SSH connection to production server" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify project path is correct" >> $GITHUB_STEP_SUMMARY
          echo "3. Check Docker Compose services status" >> $GITHUB_STEP_SUMMARY
          echo "4. Review server logs: \`docker-compose logs\`" >> $GITHUB_STEP_SUMMARY

