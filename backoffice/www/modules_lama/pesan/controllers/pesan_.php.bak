<?php

if (!defined('BASEPATH'))
    exit('No direct script access allowed');

/**
 * Description of pesan class
 *
 * @author  Yogi Cahyana
 * @since   1.0
 *
 */

class Pesan extends WRC_AdminCont {

    public function __construct() {
        parent::__construct();
        $this->pengaduan = new tmpesan();
        $this->stspesan = new trstspesan();
        $this->propinsi = new trpropinsi();
        $this->kabupaten = new trkabupaten();
        $this->kecamatan = new trkecamatan();
        $this->kelurahan = new trkelurahan();

        $enabled = FALSE;
        $list_auths = $this->session_info['app_list_auth'];
        $this->pesan = NULL;

        foreach ($list_auths as $list_auth) {
            if($list_auth->id_role === '5') {
                $enabled = TRUE;
                $this->pesan = new user_auth();
            }
        }

		/**Added by Indra **/
		if($this->__is_administrator()){$enabled=TRUE;}//Jika user memiliki peran Administrator maka berikan akses
		/*******************/
		
        if(!$enabled) {
            redirect('dashboard');
        }
    }

    public function index() {
        $data['list'] = $this->pengaduan->where("c_tindak_lanjut <> 'Hapus' " )->get();
        $data['liststspesan'] = $this->stspesan->get();

        $this->load->vars($data);

        $js =  "
                $(document).ready(function() {
                        oTable = $('#pesan').dataTable({
                                \"bJQueryUI\": true,
                                \"sPaginationType\": \"full_numbers\"
                        });
                } );
                ";

        $this->template->set_metadata_javascript($js);
        $this->session_info['page_name'] = "Setting Pesan";
        $this->template->build('list', $this->session_info);
    }

    public function create() {
        // menampilakan combobox
        $data = $this->_funcwilayah();
        $status = new trstspesan();
        $data['list_status'] = $status->get();
        $sumber = new trsumber_pesan();
        $data['list_sumber'] = $sumber->get();
        $data['propinsi_usaha'] = "";
        $data['kabupaten_usaha'] = "";
     

         $js_date = "
             $(document).ready(function() {
                    $(\"#tabs\").tabs();
                } );
            $(function() {
                $(\"#pesan\").datepicker({
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: 'yy-mm-dd',
                    closeText: 'X'
                });
            });

  $(document).ready(function() {
                        $('#propinsi_usaha_id').change(function(){
                                $('#show_kabupaten_usaha').fadeOut();
                                $.post('". base_url() ."pelayanan/pendaftaran/kabupaten_usaha', {
                                    propinsi_id: $('#propinsi_usaha_id').val()
                                }, function(response){
                                    setTimeout(\"finishAjax('show_kabupaten_usaha', '\"+escape(response)+\"')\", 400);
                                });
                                return false;
                        });
                        $('#kabupaten_usaha_id').change(function(){
                                $('#show_kecamatan_usaha').fadeOut();
                                $.post('". base_url() ."pelayanan/pendaftaran/kecamatan_usaha', {
                                    kabupaten_id: $('#kabupaten_usaha_id').val()
                                }, function(response){
                                    setTimeout(\"finishAjax('show_kecamatan_usaha', '\"+escape(response)+\"')\", 400);
                                });
                                return false;
                        });
                        $('#kecamatan_usaha_id').change(function(){
                                $('#show_kelurahan_usaha').fadeOut();
                                $.post('". base_url() ."pelayanan/pendaftaran/kelurahan_usaha', {
                                    kecamatan_id: $('#kecamatan_usaha_id').val()
                                }, function(response){
                                    setTimeout(\"finishAjax('show_kelurahan_usaha', '\"+escape(response)+\"')\", 400);
                                });
                                return false;
                        });
                });

                function finishAjax(id, response){
                  $('#'+id).html(unescape(response));
                  $('#'+id).fadeIn();
                }
            ";
        $this->template->set_metadata_javascript($js_date);


        $data['e_pesan']  = "";
        $data['RbTindakLanjut']  = "";
        $data['d_entry']  = "";
        $data['nama']  = "";
        $data['alamat']  = "";
        $data['telp']  = "";
        $data['kelurahan_usaha']  = "";
        $data['kecamatan_usaha']  = "";
        $data['tmpesan_id']  = "";
        $data['tmpesan_id']  = "";
        $data['save_method'] = "save";


        $this->load->vars($data);
        $this->session_info['page_name'] = "Tambah Pesan";
        $this->template->build('create', $this->session_info);
    }

    public function save() {

        $this->pengaduan->e_pesan = $this->input->post('e_pesan');
        $this->pengaduan->c_tindak_lajut = $this->input->post('RbTindakLanjut');
        $this->pengaduan->nama = $this->input->post('nama');
        $this->pengaduan->telp = $this->input->post('telp');
        $sumber = new trsumber_pesan();
        $sumber->get_by_id($this->input->post('sumber_pesan'));
        $status = new trstspesan();
        $status->get_by_id($this->input->post('status_pesan'));
        $this->pengaduan->alamat = $this->input->post('alamat');
        $this->pengaduan->kelurahan = $this->input->post('kelurahan_usaha');
        $this->pengaduan->kecamatan = $this->input->post('kecamatan_usaha');
        $this->pengaduan->d_entry = $this->input->post('d_entry');

        if(! $this->pengaduan->save($status)) {
            echo '<p>' . $this->pengaduan->error->string . '</p>';
        }
        if(! $this->pengaduan->save($sumber)) {
            echo '<p>' . $this->pengaduan->error->string . '</p>';
        }
        else {
            redirect('pesan');

        }

    }


    public function edit($id_pesan = NULL) {

       
        $data = $this->_funcwilayah();
        $data['propinsi_usaha'] = "";
        $data['kabupaten_usaha'] = "";
        $this->pengaduan->where('id', $id_pesan);
        $this->pengaduan->get();
        $sumber_id = $this->pengaduan->trsumber_pesan->get();
        $status_id = $this->pengaduan->trstspesan->get();

        $status = new trstspesan();
        $data['list_status'] = $status->order_by('id','DESC')->get()->all;
        $sumber = new trsumber_pesan();
        $data['list_sumber'] = $sumber->get();
        $data['RbTindakLanjut'] = $this->pengaduan->c_tindak_lanjut;
        $data['id'] = $this->pengaduan->id;
        $data['e_pesan'] = $this->pengaduan->e_pesan;
        $data['nama'] = $this->pengaduan->nama;
        $data['telp'] = $this->pengaduan->telp;
        $data['alamat'] = $this->pengaduan->alamat;
        $data['e_pesan_koreksi'] = $this->pengaduan->e_pesan_koreksi;
        $data['kelurahan_usaha'] = $this->pengaduan->kelurahan;
        $data['kecamatan_usaha'] = $this->pengaduan->kecamatan;
        $data['sumber_pesan'] = $sumber_id->id;
        $data['status_pesan'] = $status_id->id;

         $js_date = "
             $(document).ready(function() {
                    $(\"#tabs\").tabs();
                } );
            $(function() {
                $(\"#pesan\").datepicker({
                    changeMonth: true,
                    changeYear: true,
                    dateFormat: 'yy-mm-dd',
                    closeText: 'X'
                });
            });
             $(document).ready(function() {
                        $('#propinsi_usaha_id').change(function(){
                                $('#show_kabupaten_usaha').fadeOut();
                                $.post('". base_url() ."pelayanan/pendaftaran/kabupaten_usaha', {
                                    propinsi_id: $('#propinsi_usaha_id').val()
                                }, function(response){
                                    setTimeout(\"finishAjax('show_kabupaten_usaha', '\"+escape(response)+\"')\", 400);
                                });
                                return false;
                        });
                        $('#kabupaten_usaha_id').change(function(){
                                $('#show_kecamatan_usaha').fadeOut();
                                $.post('". base_url() ."pelayanan/pendaftaran/kecamatan_usaha', {
                                    kabupaten_id: $('#kabupaten_usaha_id').val()
                                }, function(response){
                                    setTimeout(\"finishAjax('show_kecamatan_usaha', '\"+escape(response)+\"')\", 400);
                                });
                                return false;
                        });
                        $('#kecamatan_usaha_id').change(function(){
                                $('#show_kelurahan_usaha').fadeOut();
                                $.post('". base_url() ."pelayanan/pendaftaran/kelurahan_usaha', {
                                    kecamatan_id: $('#kecamatan_usaha_id').val()
                                }, function(response){
                                    setTimeout(\"finishAjax('show_kelurahan_usaha', '\"+escape(response)+\"')\", 400);
                                });
                                return false;
                        });
                });

                function finishAjax(id, response){
                  $('#'+id).html(unescape(response));
                  $('#'+id).fadeIn();
                }
            ";
        $this->template->set_metadata_javascript($js_date);
        $data['d_entry'] = $this->pengaduan->d_entry;
        $data['save_method'] = "update";

        $this->load->vars($data);
        $this->session_info['page_name'] = "Edit Pesan";
        $this->template->build('edit', $this->session_info);
    }

    public function update() {
        $update = $this->pengaduan
                ->where('id', $this->input->post('id'))
                ->update(array(
                    'id' => $this->input->post('id'),
                    'c_tindak_lanjut' => $this->input->post('RbTindakLanjut'),
                    'nama' => $this->input->post('nama'),
                    'telp' => $this->input->post('telp'),
                    'alamat' => $this->input->post('alamat'),
                    'kecamatan' => $this->input->post('kecamatan_usaha'),
                    'e_pesan_koreksi' => $this->input->post('e_pesan_koreksi'),
                    'kelurahan' => $this->input->post('kelurahan_usaha'),
                    'd_entry' => $this->input->post('d_entry')));
        $sumber = new tmpesan_trsumber();
        $sumber->where('tmpesan_id', $this->input->post('id'))
        ->update(array('trsumber_pesan_id' => $this->input->post('sumber_pesan')));

        $status = new tmpesan_trstspesan();
        $status->where('tmpesan_id', $this->input->post('id'))
        ->update(array('trstspesan_id' => $this->input->post('status_pesan')));

        if($update) {
            redirect('pesan');
        }
    }

    public function delete($pesan_id = NULL) {
        $this->pengaduan->where('id', $pesan_id)->get();
        if($this->pengaduan->delete()) {
            redirect('pesan');
        }
    }


    public function filterdata() {
	$this->stspesan->where('id', $this->input->post('sts_pesan'))->get();
	$data['liststspesan'] = $this->stspesan->order_by('id', 'ASC')->get();

        $data['sts_pesan'] = $this->stspesan->get_by_id($this->input->post('sts_pesan'));


        $data['list'] = $this->stspesan->tmpesan->where("c_tindak_lanjut <> 'Hapus'" )->get($this->stspesan);
        $this->load->vars($data);


        $js = "
        $(document).ready(function() {
                oTable = $('#pesan').dataTable({
                        \"bJQueryUI\": true,
                        \"sPaginationType\": \"full_numbers\"
                });
        } );
        ";

        $this->template->set_metadata_javascript($js);
        $this->session_info['page_name'] = $this->stspesan->n_sts_pesan;
        $this->template->build('view_pesan', $this->session_info);
    }

    function _funcwilayah(){
        $data['list_propinsi'] = $this->propinsi->order_by('n_propinsi','ASC')->get();
        $data['list_kabupaten'] = $this->kabupaten->order_by('n_kabupaten','ASC')->get();
        $data['list_kecamatan'] = $this->kecamatan->order_by('n_kecamatan','ASC')->get();
        $data['list_kelurahan'] = $this->kelurahan->order_by('n_kelurahan','ASC')->get();

        return $data;
    }

   
}

// This is the end of pesan class
